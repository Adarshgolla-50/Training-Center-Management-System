{% extends "base.html" %}

{% block content %}
{% if session.get('is_password_changed', 0) == 0 %}
<div class="row">
    <div class="col-md-12">
        <div class="alert alert-warning alert-dismissible fade show" role="alert">
            <strong>Important!</strong> You need to change your password for security reasons.
            <a href="{{ url_for('auth.change_password') }}" class="alert-link">Change Password Now</a>.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    </div>
</div>
{% endif %}
<div class="row">
    <div class="col-md-12 grid-margin">
        <div class="row">
            <div class="col-12 col-xl-8 mb-4 mb-xl-0">
                <h3 class="font-weight-bold">Welcome, {{ session.get('user_name') | capitalize }}!</h3>
                <h6 class="font-weight-normal mb-0">Manage your assigned courses, batches, and student performance efficiently!</h6>
            </div>
        </div>
    </div>
</div>

<!-- Dashboard Cards -->
<div class="row">
    
    <div class="col-md-3 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <p class="card-title">Batches</p>
                <div class="d-flex justify-content-between align-items-center">
                    <h3>{{ active_batches }}</h3>
                    <i class="mdi mdi-calendar-check icon-md text-success"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <p class="card-title">Total Students</p>
                <div class="d-flex justify-content-between align-items-center">
                    <h3>{{ total_students }}</h3>
                    <i class="mdi mdi-account-group icon-md text-warning"></i>
                </div>
            </div>
        </div>
    </div>
    <!-- <div class="col-md-3 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <p class="card-title">Pending Leave Requests</p>
                <div class="d-flex justify-content-between align-items-center">
                    <h3>{{ pending_leave_requests }}</h3>
                    <i class="mdi mdi-alert-circle icon-md text-danger"></i>
                </div>
            </div>
        </div>
    </div> -->
    <div class="col-md-3 grid-margin stretch-card">
    <div class="card">
        <div class="card-body">
        <p class="card-title">Today's Absentees</p>
        <div class="d-flex justify-content-between align-items-center">
            <h3>{{ absentees_today }}/{{ total_students }}</h3>
            <i class="mdi mdi-account-remove icon-md text-danger"></i>
        </div>
        </div>
    </div>
</div>
<!-- <div class="col-md-3 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <p class="card-title">My Courses</p>
                <div class="d-flex justify-content-between align-items-center">
                    <h3>{{ total_assigned_courses }}</h3>
                    <i class="mdi mdi-book-open-page-variant icon-md text-primary"></i>
                </div>
            </div>
        </div>
    </div>
</div> -->
<div class="col-md-3 grid-margin stretch-card">
    <div class="card">
        <div class="card-body">
            <p class="card-title">My Courses</p>
            <div class="d-flex justify-content-between align-items-center">
                <div>
                                        
                    <ul class="list-unstyled mb-0" style="font-size: 1rem;">
                        {% for course in assigned_courses %}
                            <li>{{ course }}</li>
                        {% endfor %}
                    </ul>
                    <span class="text-muted" style="font-size: 1rem;">Avg Grade: <strong>{{ avg_grade or 'N/A' }}</strong></span>
                </div>
                <i class="mdi mdi-book-open-page-variant icon-md text-primary"></i>
            </div>
        </div>
    </div>
</div>

<!-- Course-wise Topics & Assignments Chart -->
<!-- <div class="row mt-4">
    <div class="col-lg-12 grid-margin stretch-card">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="card-title">Course-wise Topics & Assignments</h4>
                {% if course_chart %}
                    <img src="data:image/png;base64,{{ course_chart }}" class="img-fluid" alt="Course Stats">
                {% else %}
                    <p>No course data available.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div> -->

<!-- Topic-wise Assignment Distribution -->
<div class="row mt-4">
    <!-- <div class="col-lg-6 grid-margin stretch-card">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="card-title">Topic-wise Assignment Distribution</h4>
                {% if topic_chart %}
                    <img src="data:image/png;base64,{{ topic_chart }}" class="img-fluid" alt="Topic Assignment Distribution">
                {% else %}
                    <p>No topic data available.</p>
                {% endif %}
            </div>
        </div>
    </div> -->

    <!-- Assignment Marks Distribution (Chart.js) -->
    <div class="col-lg-6 grid-margin stretch-card">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="card-title">Assignment Marks Distribution</h4>
                <canvas id="marksDistributionChart" height="200"></canvas>
                <p id="noMarksData" style="display:none;">No marks data available.</p>
            </div>
        </div>
    </div>


<!-- Student Completion Rates -->

    <!-- <div class="col-lg-6 grid-margin stretch-card">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="card-title">Student Completion Rates</h4>
                {% if completion_chart %}
                    <img src="data:image/png;base64,{{ completion_chart }}" class="img-fluid" alt="Completion Rates">
                {% else %}
                    <p>No completion data available.</p>
                {% endif %}
            </div>
        </div>
    </div> -->
    <div class="col-lg-6 grid-margin stretch-card">
    <div class="card text-center">
        <div class="card-body d-flex flex-column justify-content-center align-items-center" style="min-height: 320px;">
            <h4 class="card-title w-100">Assignment Submissions & To Grade</h4>
            <div style="display: flex; justify-content: center; align-items: center; width: 100%;">
                <canvas id="donutChart" width="250" height="250"></canvas>
            </div>
            <p id="noDonutData" style="display:none;">No submission data available.</p>
        </div>
    </div>
</div>
</div>

<!-- Performance Trends -->
<!-- <div class="row mt-4">
    <div class="col-lg-12 grid-margin stretch-card">
        <div class="card text-center">
            <div class="card-body">
                <h4 class="card-title">Student Performance Trends</h4>
                {% if performance_chart %}
                    <img src="data:image/png;base64,{{ performance_chart }}" class="img-fluid" alt="Performance Trends">
                {% else %}
                    <p>No performance data available.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div> -->

<!-- Upcoming Assignment Deadlines -->
<!-- <div class="row mt-4">
    <div class="col-lg-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Upcoming Assignment Deadlines</h4>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Assignment</th>
                                <th>Batch</th>
                                <th>Due Date</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assign in upcoming_assignments %}
                            <tr>
                                <td>{{ assign.title }}</td>
                                <td>{{ assign.batch_name }}</td>
                                <td>{{ assign.due_date }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="3" class="text-center">No upcoming assignments</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div> -->

<!-- Recent Activities -->
<!-- <div class="row mt-4">
    <div class="col-lg-12 grid-margin stretch-card">
        <div class="card">
            <div class="card-body">
                <h4 class="card-title">Recent Activities</h4>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Action</th>
                                <th>Details</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for activity in recent_activities %}
                            <tr>
                                <td>{{ activity.timestamp }}</td>
                                <td>{{ activity.action }}</td>
                                <td>{{ activity.details }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="3" class="text-center">No recent activity found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div> -->
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const marksLabels = {{ marks_labels_json|safe }};
    const marksCounts = {{ marks_counts_json|safe }};
    if (marksCounts.reduce((a, b) => a + b, 0) === 0) {
        document.getElementById('marksDistributionChart').style.display = 'none';
        document.getElementById('noMarksData').style.display = 'block';
    } else {
        const ctx = document.getElementById('marksDistributionChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: marksLabels,
                datasets: [{
                    label: 'Number of Students',
                    data: marksCounts,
                    backgroundColor: '#3d3de8',
                    borderRadius: 6,
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    title: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 }
                    }
                }
            }
        });
    }
</script>

<script>
    const donutData = [{{ total_submitted }}, {{ total_to_grade }}];
    const donutLabels = ["Submitted", "To Grade"];
    if (donutData.reduce((a, b) => a + b, 0) === 0) {
        document.getElementById('donutChart').style.display = 'none';
        document.getElementById('noDonutData').style.display = 'block';
    } else {
        const ctxDonut = document.getElementById('donutChart').getContext('2d');
        new Chart(ctxDonut, {
            type: 'doughnut',
            data: {
                labels: donutLabels,
                datasets: [{
                    data: donutData,
                    backgroundColor: ['#42a5f5', '#ffb300'],
                    borderRadius: 6,
                }]
            },
            options: {
                responsive: false,
                aspectRatio: 1,
                plugins: {
                    legend: { position: 'bottom' },
                    title: { display: false }
                }
            }
        });
    }
</script>
{% endblock %}

<style>
    #donutChart {
        display: block;
        margin-left: auto;
        margin-right: auto;
    }
</style>
