{% extends "base.html" %}

{% block content %}
<div class="container mt-4" style="max-width: 800px;">
    <h3 class="text-center mb-4">Student Profile</h3>

    <!-- Profile Completion Progress -->
    <div class="mb-4">
        <label class="form-label fw-bold">Profile Completion: {{ completion }}%</label>
        <div class="progress">
            <div class="progress-bar" role="progressbar" style="width: {{ completion }}%;" 
                 aria-valuenow="{{ completion }}" aria-valuemin="0" aria-valuemax="100">
                {{ completion }}%
            </div>
        </div>
    </div>

    <form method="POST" enctype="multipart/form-data" class="d-flex flex-column align-items-center">
        <!-- Profile Photo with Cropper -->
        <div class="position-relative mb-4" style="width: 120px;">
            {% if student.profile_photo %}
                <img id="profilePreview" 
                     src="{{ url_for('static', filename='uploads/profiles/' + student.profile_photo) }}" 
                     alt="Profile Photo" class="img-thumbnail rounded-circle" 
                     style="width:120px;height:120px;object-fit:cover;">
            {% else %}
                <img id="profilePreview" 
                     src="{{ url_for('static', filename='images/default_profile.png') }}" 
                     alt="Profile Photo" class="img-thumbnail rounded-circle" 
                     style="width:120px;height:120px;object-fit:cover;">
            {% endif %}

            <!-- Hidden file input -->
            <input type="file" name="profile_photo" id="profilePhotoInput" class="d-none" accept="image/*">

            <!-- Overlay for changing photo -->
            <div class="position-absolute bottom-0 start-50 translate-middle-x bg-dark bg-opacity-50 text-white py-1 px-2 rounded"
                 style="cursor:pointer; white-space: nowrap; min-width: 120px; text-align: center;"
                 onclick="document.getElementById('profilePhotoInput').click();">
                <i class="bi bi-camera-fill me-1"></i> Change Photo
            </div>
        </div>

        <!-- Form fields -->
        <div class="w-100" style="max-width: 800px;">
            <div class="row g-3 mt-3">
                <div class="col-md-6">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-control" value="{{ student.full_name or '' }}" readonly>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" value="{{ student.email or '' }}" readonly>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Date of Birth</label>
                    <input type="date" name="dob" class="form-control" value="{{ student.dob or '' }}">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Guardian Name</label>
                    <input type="text" name="guardian_name" class="form-control" value="{{ student.guardian_name or '' }}">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Blood Group</label>
                    <select name="blood_group" class="form-select">
                        <option value="">Select Blood Group</option>
                        {% for bg in ['A+', 'A-', 'B+', 'B-', 'O+', 'O-', 'AB+', 'AB-'] %}
                            <option value="{{ bg }}" {% if student.blood_group == bg %}selected{% endif %}>{{ bg }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Country / State / City -->
                <div class="col-md-6">
                    <label class="form-label">Country</label>
                    <select id="country" name="country" class="form-select"></select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">State</label>
                    <select id="state" name="state" class="form-select"></select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">City</label>
                    <select id="city" name="city" class="form-select"></select>
                </div>

                <div class="col-md-6">
                    <label class="form-label">Zip Code</label>
                    <input type="text" name="zip_code" class="form-control" value="{{ student.zip_code or '' }}">
                </div>

                <div class="col-md-6">
                    <label class="form-label">Emergency Contact Name</label>
                    <input type="text" name="emergency_contact_name" class="form-control" value="{{ student.emergency_contact_name or '' }}">
                </div>
                <div class="col-md-6">
                    <label class="form-label">Emergency Contact Phone</label>
                    <input type="text" name="emergency_contact_phone" class="form-control" value="{{ student.emergency_contact_phone or '' }}">
                </div>

                <div class="col-md-12">
                    <label class="form-label">Address</label>
                    <input type="text" name="address" class="form-control" value="{{ student.address or '' }}">
                </div>
            </div>

            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary px-5">Update Profile</button>
            </div>
        </div>
    </form>
</div>

<!-- Cropper.js Modal -->
<div class="modal fade" id="cropModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Crop Profile Photo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        <img id="cropImage" style="max-width:100%; display:block; margin:auto;">
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="cropSaveBtn">Save</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>

<script>
let cropper;
const profileInput = document.getElementById('profilePhotoInput');
const profilePreview = document.getElementById('profilePreview');
const cropImage = document.getElementById('cropImage');
const cropModal = new bootstrap.Modal(document.getElementById('cropModal'));

profileInput.addEventListener('change', function(e){
    const file = e.target.files[0];
    if(file){
        const reader = new FileReader();
        reader.onload = function(event){
            cropImage.src = event.target.result;
            cropModal.show();

            if(cropper) cropper.destroy();
            cropper = new Cropper(cropImage, {
                aspectRatio: 1,
                viewMode: 1,
                movable: true,
                zoomable: true,
                rotatable: false,
                scalable: false,
            });
        };
        reader.readAsDataURL(file);
    }
});

document.getElementById('cropSaveBtn').addEventListener('click', function(){
    const canvas = cropper.getCroppedCanvas({ width: 300, height: 300 });
    profilePreview.src = canvas.toDataURL();
    canvas.toBlob(function(blob){
        const file = new File([blob], "profile.png", { type: "image/png" });
        const dataTransfer = new DataTransfer();
        dataTransfer.items.add(file);
        profileInput.files = dataTransfer.files;
    });
    cropModal.hide();
});

/* Country / State / City */
const apiKey = "WW95T244eHE4RWcxRndWQWFIclFhQTdCc2I5TkZuTGJwWEdJMlM4aQ==";
const headers = { "X-CSCAPI-KEY": apiKey };

const countrySelect = document.getElementById('country');
const stateSelect = document.getElementById('state');
const citySelect = document.getElementById('city');

const studentCountry = "{{ student.country or '' }}";
const studentState = "{{ student.state or '' }}";
const studentCity = "{{ student.city or '' }}";

async function loadCountries() {
    countrySelect.innerHTML = '<option value="">Select Country</option>';
    stateSelect.innerHTML = '<option value="">Select State</option>';
    citySelect.innerHTML = '<option value="">Select City</option>';

    const res = await fetch("https://api.countrystatecity.in/v1/countries", { headers });
    const countries = await res.json();
    countries.forEach(c => {
        const option = new Option(c.name, c.name);
        if(c.name === studentCountry) option.selected = true;
        countrySelect.appendChild(option);
    });
    if(studentCountry) loadStates(studentCountry);
}

async function loadStates(countryName) {
    stateSelect.innerHTML = '<option value="">Select State</option>';
    citySelect.innerHTML = '<option value="">Select City</option>';
    if(!countryName) return;

    const res = await fetch(`https://api.countrystatecity.in/v1/countries`, { headers });
    const countries = await res.json();
    const country = countries.find(c => c.name === countryName);
    if(!country) return;

    const resStates = await fetch(`https://api.countrystatecity.in/v1/countries/${country.iso2}/states`, { headers });
    const states = await resStates.json();
    states.forEach(s => {
        const option = new Option(s.name, s.name);
        if(s.name === studentState) option.selected = true;
        stateSelect.appendChild(option);
    });
    if(studentState) loadCities(country.iso2, studentState);
}

async function loadCities(countryIso, stateName) {
    citySelect.innerHTML = '<option value="">Select City</option>';
    if(!stateName) return;

    const resStates = await fetch(`https://api.countrystatecity.in/v1/countries/${countryIso}/states`, { headers });
    const states = await resStates.json();
    const state = states.find(s => s.name === stateName);
    if(!state) return;

    const resCities = await fetch(`https://api.countrystatecity.in/v1/countries/${countryIso}/states/${state.iso2}/cities`, { headers });
    const cities = await resCities.json();
    cities.forEach(c => {
        const option = new Option(c.name, c.name);
        if(c.name === studentCity) option.selected = true;
        citySelect.appendChild(option);
    });
}

countrySelect.addEventListener('change', () => loadStates(countrySelect.value));
stateSelect.addEventListener('change', () => {
    const selectedCountry = countrySelect.value;
    const countryIso = Array.from(countrySelect.options).find(o => o.value === selectedCountry).dataset.iso2;
    loadCities(countryIso, stateSelect.value);
});

loadCountries();
</script>
{% endblock %}
