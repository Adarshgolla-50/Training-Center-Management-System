{% extends "base.html" %}
{% block content %}
<div class="container">
  <h2 class="mb-4">Attendance Reports & Statistics</h2>

  <!-- Filters -->
  <form method="get" class="row g-3 mb-4">
    <div class="col-md-3">
      <label class="form-label">Select Batch</label>
      <select name="batch_id" class="form-select" required>
        <option value="">-- Choose Batch --</option>
        {% for b in batches %}
          <option value="{{ b.batch_id }}" {% if batch_id == b.batch_id|string %}selected{% endif %}>{{ b.batch_name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">From</label>
      <input type="date" name="start_date" class="form-control" value="{{ start_date }}" required>
    </div>
    <div class="col-md-2">
      <label class="form-label">To</label>
      <input type="date" name="end_date" class="form-control" value="{{ end_date }}" required>
    </div>
    <div class="col-md-2">
      <label class="form-label">Rows per page</label>
      <select name="per_page" class="form-select">
        {% for n in [5, 10, 20, 40] %}
          <option value="{{ n }}" {% if per_page|int == n %}selected{% endif %}>{{ n }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button type="submit" class="btn btn-primary w-100">Generate</button>
    </div>
  </form>

  {% if report %}
  <div class="mb-3 d-flex gap-2">
    <a href="{{ url_for('admin.export_attendance_csv', batch_id=batch_id, start_date=start_date, end_date=end_date) }}" class="btn btn-success">Export CSV</a>
    <button type="button" class="btn btn-info" data-bs-toggle="modal" data-bs-target="#chartModal">View Chart</button>
  </div>

  <!-- Attendance Table -->
  <div class="table-responsive mb-3">
    <table class="table table-bordered table-striped">
      <thead class="table-light">
        <tr>
          <th>Roll No</th>
          <th>Student Name</th>
          <th>Total Classes</th>
          <th>Present</th>
          <th>Absent</th>
          <th>% Attendance</th>
        </tr>
      </thead>
      <tbody>
        {% for r in report %}
        <tr>
          <td>{{ r.roll_no }}</td>
          <td>{{ r.name }}</td>
          <td>{{ r.total_classes }}</td>
          <td>{{ r.present_count }}</td>
          <td>{{ r.absent_count }}</td>
          <td>{{ r.attendance_percent }}%</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

 <!-- Pagination -->
{% if total_pages > 1 %}
<nav aria-label="Page navigation">
  <ul class="pagination justify-content-center">
    <li class="page-item {% if page <= 1 %}disabled{% endif %}">
      <a class="page-link" href="?batch_id={{ batch_id }}&start_date={{ start_date }}&end_date={{ end_date }}&per_page={{ per_page }}&page={{ page-1 }}">Previous</a>
    </li>

    {% for p in range(1, total_pages + 1) %}
    <li class="page-item {% if page == p %}active{% endif %}">
      <a class="page-link" href="?batch_id={{ batch_id }}&start_date={{ start_date }}&end_date={{ end_date }}&per_page={{ per_page }}&page={{ p }}">{{ p }}</a>
    </li>
    {% endfor %}

    <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
      <a class="page-link" href="?batch_id={{ batch_id }}&start_date={{ start_date }}&end_date={{ end_date }}&per_page={{ per_page }}&page={{ page+1 }}">Next</a>
    </li>
  </ul>
</nav>
{% endif %}

  <!-- Modal for Pie Chart -->
  <div class="modal fade" id="chartModal" tabindex="-1" aria-labelledby="chartModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="chartModalLabel">Attendance Distribution</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <canvas id="attendancePieChart" height="250"></canvas>
        </div>
      </div>
    </div>
  </div>

  {% endif %}
</div>

<!-- Bootstrap 5 JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
{% if report %}
let pieChartInitialized = false;
const chartModal = document.getElementById('chartModal');

chartModal.addEventListener('shown.bs.modal', function () {
    if (!pieChartInitialized) {
        const ctx = document.getElementById('attendancePieChart').getContext('2d');

        let low = 0, medium = 0, high = 0;
        {% for r in report %}
            {% if r.attendance_percent|float <= 50 %}
                low += 1;
            {% elif r.attendance_percent|float <= 75 %}
                medium += 1;
            {% else %}
                high += 1;
            {% endif %}
        {% endfor %}

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: ['0-50% (Low)', '51-75% (Medium)', '76-100% (High)'],
                datasets: [{
                    data: [low, medium, high],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.6)',
                        'rgba(255, 206, 86, 0.6)',
                        'rgba(75, 192, 192, 0.6)'
                    ],
                    borderColor: [
                        'rgba(255,99,132,1)',
                        'rgba(255,206,86,1)',
                        'rgba(75,192,192,1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' } }
            }
        });

        pieChartInitialized = true;
    }
});
{% endif %}
</script>
{% endblock %}
