{% extends "base.html" %}
{% block content %}

<style>
    .form-check-input:checked { background-color: #28a745 !important; border-color: #28a745 !important; }
    .form-check-input:not(:checked) { background-color: #dc3545 !important; border-color: #dc3545 !important; }
    th.sortable { cursor: pointer; position: relative; text-align: left; padding-right: 20px; }
    th.sortable::after { content: "‚áÖ"; font-size: 0.8rem; position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: #6c757d; }
    th.sortable.asc::after { content: "‚Üë"; color: #28a745; }
    th.sortable.desc::after { content: "‚Üì"; color: #dc3545; }
    table.table { width: 100%; table-layout: auto; }
    td, th { vertical-align: middle; white-space: nowrap; transition: background-color 0.3s; }
    td:nth-child(2) { max-width: 250px; white-space: normal; }
    table.table-hover tbody tr:hover { background-color: #f1f8ff; }
</style>

<div class="row">
    <div class="col-md-12 grid-margin">
        <div class="row">
            <div class="col-12 col-xl-8 mb-4 mb-xl-0">
                <h3 class="font-weight-bold">Student Management</h3>
                <h6 class="font-weight-normal mb-0">Manage all students</h6>
            </div>
        </div>
    </div>
</div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="mt-2">
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}

<div class="row mt-4">
    <div class="col-lg-12 grid-margin stretch-card">
        <div class="card shadow-lg border-0" style="border-radius: 1rem; padding: 1rem;">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="card-title mb-0">All Students</h4>                   
                </div>

                <!-- Search box -->
                <div class="mb-3">
                    <input type="text" id="searchInput" class="form-control" placeholder="Search by student name...">
                </div>

                <div class="table-responsive">
                    <table class="table table-hover" id="studentsTable">
                        <thead class="table-light">
                            <tr>
                                <th class="sortable">ID</th>
                                <th class="sortable">Name</th>
                                <th class="sortable">Admission No</th>
                                <th class="sortable">Enrollment Date</th>
                                <th>Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for student in students %}
                            <tr id="studentRow{{ student.student_id }}">
                                <td>{{ student.student_id }}</td>
                                <td>{{ student.full_name }}</td>
                                <td>{{ student.admission_no }}</td>
                                <td>{{ student.enrollment_date or '-' }}</td>
                                <td class="text-center">
                                    <div class="form-check form-switch d-flex align-items-center justify-content-center">
                                        <input class="form-check-input active-toggle" type="checkbox"
                                            data-student-id="{{ student.student_id }}" {% if student.is_active %}checked{% endif %}>
                                        <span class="ms-2 fw-bold active-label {{ 'text-success' if student.is_active else 'text-danger' }}">
                                            {{ 'Active' if student.is_active else 'Inactive' }}
                                        </span>
                                    </div>
                                </td>
                                <td>
                                    <button type="button" 
                                            class="btn btn-sm btn-primary me-2 view-student-btn"
                                            data-bs-toggle="modal"
                                            data-bs-target="#viewStudentModal"
                                            data-student='{{ student | tojson }}'>
                                        View
                                    </button>
                                    <a href="{{ url_for('admin.edit_student', student_id=student.student_id) }}" 
                                       class="btn btn-sm btn-info me-2">Edit</a>
                                    <a href="{{ url_for('admin.delete_student', student_id=student.student_id) }}" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this student?')">Delete</a>
                            </tr>
                            {% else %}
                            <tr id="noStudentsRow">
                                <td colspan="9" class="text-center">No students found.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Student Modal -->
<div class="modal fade" id="viewStudentModal" tabindex="-1" aria-labelledby="viewStudentModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="viewStudentModalLabel">üë®‚Äçüéì Student Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="container-fluid">
          <div class="row g-3">
            <div class="col-md-6">
              <p class="mb-1 text-muted">ID</p>
              <p class="fw-semibold" id="vs-id"></p>

              <p class="mb-1 text-muted">Full Name</p>
              <p class="fw-semibold" id="vs-name"></p>

              <p class="mb-1 text-muted">Admission No</p>
              <p class="fw-semibold" id="vs-admno"></p>

              <p class="mb-1 text-muted">DOB</p>
              <p class="fw-semibold" id="vs-dob"></p>
            </div>

            <div class="col-md-6">
              <p class="mb-1 text-muted">Guardian Name</p>
              <p class="fw-semibold" id="vs-guardian"></p>

              <p class="mb-1 text-muted">Phone</p>
              <p class="fw-semibold" id="vs-phone"></p>

              <p class="mb-1 text-muted">Enrollment Date</p>
              <p class="fw-semibold" id="vs-enroll"></p>

              <p class="mb-1 text-muted">Active</p>
              <p class="fw-semibold" id="vs-active"></p>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-danger" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Table Sorting
    document.querySelectorAll("#studentsTable th.sortable").forEach((header, index) => {
        header.addEventListener("click", () => {
            const table = header.closest("table");
            const tbody = table.querySelector("tbody");
            const rows = Array.from(tbody.querySelectorAll("tr")).filter(r => !r.id.includes("noStudentsRow"));

            const isAscending = header.classList.contains("asc");
            const direction = isAscending ? -1 : 1;

            table.querySelectorAll("th.sortable").forEach(th => th.classList.remove("asc", "desc"));
            header.classList.toggle("asc", !isAscending);
            header.classList.toggle("desc", isAscending);

            rows.sort((a, b) => {
                const cellA = a.children[index].textContent.trim().toLowerCase();
                const cellB = b.children[index].textContent.trim().toLowerCase();
                const numA = parseFloat(cellA);
                const numB = parseFloat(cellB);
                if (!isNaN(numA) && !isNaN(numB)) return (numA - numB) * direction;
                return cellA.localeCompare(cellB) * direction;
            });

            rows.forEach(row => tbody.appendChild(row));
        });
    });

    // Active/Inactive Toggle
    document.querySelectorAll('.active-toggle').forEach(toggle => {
        toggle.addEventListener('change', function () {
            const studentId = this.dataset.studentId;
            const isActive = this.checked ? 1 : 0;
            const activeLabel = this.closest('.form-check').querySelector('.active-label');

            fetch(`/admin/toggle_student_status/${studentId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_active: isActive })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    activeLabel.textContent = isActive ? "Active" : "Inactive";
                    activeLabel.classList.toggle("text-success", isActive);
                    activeLabel.classList.toggle("text-danger", !isActive);
                } else {
                    alert("Failed to update status");
                    this.checked = !isActive;
                }
            })
            .catch(() => {
                alert("Error updating status");
                this.checked = !isActive;
            });
        });
    });

    // Search Filter (Name only)
    document.getElementById("searchInput").addEventListener("keyup", function() {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll("#studentsTable tbody tr");
        let visibleCount = 0;

        rows.forEach(row => {
            if (row.id.includes("noStudentsRow")) return;
            const nameCell = row.children[1];
            if (nameCell && nameCell.textContent.toLowerCase().includes(filter)) {
                row.style.display = "";
                visibleCount++;
            } else {
                row.style.display = "none";
            }
        });

        const noStudentsRow = document.getElementById("noStudentsRow");
        if (noStudentsRow) noStudentsRow.style.display = visibleCount === 0 ? "" : "none";
    });

    // View Student Modal
    document.querySelectorAll('.view-student-btn').forEach(btn => {
        btn.addEventListener('click', function () {
            const student = JSON.parse(this.getAttribute('data-student'));
            document.getElementById('vs-id').textContent = student.student_id ?? '-';
            document.getElementById('vs-name').textContent = student.full_name ?? '-';
            document.getElementById('vs-admno').textContent = student.admission_no ?? '-';
            document.getElementById('vs-dob').textContent = student.dob ?? '-';
            document.getElementById('vs-guardian').textContent = student.guardian_name ?? '-';
            document.getElementById('vs-phone').textContent = student.phone ?? '-';
            document.getElementById('vs-enroll').textContent = student.enrollment_date ?? '-';
            document.getElementById('vs-active').innerHTML = student.is_active
                ? '<span class="badge bg-success">Active</span>'
                : '<span class="badge bg-danger">Inactive</span>';
        });
    });

    // Delete Student
    document.querySelectorAll('.btn-danger').forEach(btn => {
        btn.addEventListener('click', function (e) {
            e.preventDefault();
            const studentId = this.closest('tr').id.replace('studentRow', '');
            if (confirm('Are you sure you want to delete this student?')) {
                fetch('/admin/delete_student/' + studentId, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('studentRow' + studentId).remove();
                        const noStudentsRow = document.getElementById("noStudentsRow");
                        if (noStudentsRow) noStudentsRow.style.display = "table-row";
                    } else {
                        alert(data.error || 'Delete failed');
                    }
                });
            }
        });
    });
</script>

{% endblock %}
