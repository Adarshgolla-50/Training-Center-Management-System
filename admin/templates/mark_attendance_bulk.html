{% extends "base.html" %}
{% block content %}
<div class="container">
  <h2 class="mb-4">Mark Attendance</h2>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mt-3">
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}

  <!-- Batch and Date Selection -->
  <form method="get" class="row g-3 mb-4">
    <div class="col-md-4">
      <label for="batch_id" class="form-label">Select Batch</label>
      <select name="batch_id" id="batch_id" class="form-select" required>
        <option value="">-- Choose Batch --</option>
        {% for b in batches %}
          <option value="{{ b.batch_id }}"
            {% if selected_batch == b.batch_id %}selected{% endif %}>
            {{ b.name }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-4">
      <label for="attendance_date" class="form-label">Attendance Date</label>
      <input type="date" name="attendance_date" id="attendance_date"
             value="{{ selected_date or default_date }}" class="form-control" required>
    </div>

    <div class="col-md-4 d-flex align-items-end">
      <button type="submit" class="btn btn-primary">Load Students</button>
    </div>
  </form>

  {% if students %}
  <!-- Bulk Action Buttons -->
  <div class="mb-3">
    <button type="button" class="btn btn-success btn-sm me-2" onclick="markAll('PRESENT')">
      <i class="bi bi-check-circle-fill"></i> Mark All Present
    </button>
    <button type="button" class="btn btn-danger btn-sm" onclick="markAll('ABSENT')">
      <i class="bi bi-x-circle-fill"></i> Mark All Absent
    </button>
  </div>

  <!-- Attendance Marking Table -->
  <form method="post" id="attendanceForm">
    <input type="hidden" name="batch_id" value="{{ selected_batch }}">
    <input type="hidden" name="attendance_date" value="{{ selected_date }}">

    <div class="table-responsive">
      <table class="table table-bordered align-middle">
        <thead class="table-light">
          <tr>
            <th>Roll No</th>
            <th>Student Name</th>
            <th class="text-center" colspan="2">Attendance</th>
            <th>Remarks</th>
          </tr>
        </thead>
        <tbody>
          {% for s in students %}
          <tr>
            <td>{{ s.roll_no }}</td>
            <td>{{ s.name }}</td>
            <td colspan="2" class="text-center">
              <div class="attendance-toggle">
                <!-- Present -->
                <div class="attendance-option">
                  <input type="radio" name="status_{{ s.student_id }}" id="present_{{ s.student_id }}" value="PRESENT"
                    {% if attendance.get(s.student_id) == 'PRESENT' %}checked{% endif %} required>
                  <label for="present_{{ s.student_id }}" class="attendance-label present">
                    <i class="bi bi-check-circle-fill"></i> Present
                  </label>
                </div>

                <!-- Absent -->
                <div class="attendance-option">
                  <input type="radio" name="status_{{ s.student_id }}" id="absent_{{ s.student_id }}" value="ABSENT"
                    {% if attendance.get(s.student_id) == 'ABSENT' %}checked{% endif %}>
                  <label for="absent_{{ s.student_id }}" class="attendance-label absent">
                    <i class="bi bi-x-circle-fill"></i> Absent
                  </label>
                </div>
              </div>
            </td>
            <td>
              <input type="text" name="remarks_{{ s.student_id }}" class="form-control"
                     value="{{ remarks.get(s.student_id, '') }}" placeholder="Optional remarks">
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="text-end mt-3">
      <button type="submit" class="btn btn-success">Save Attendance</button>
    </div>
  </form>
  {% endif %}
</div>

<!-- Custom Styles -->
<style>
.attendance-toggle {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.attendance-option {
  flex: 1;
  position: relative;
}

.attendance-option input[type="radio"] {
  display: none; /* hide default radio */
}

.attendance-label {
  display: block;
  padding: 10px;
  border-radius: 8px;
  text-align: center;
  font-weight: 600;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.2s ease-in-out;
  user-select: none;
}

/* Default colors */
.attendance-label.present {
  background: #e6f9ec;
  color: #198754;
  border: 2px solid #c1e8cc;
}

.attendance-label.absent {
  background: #fdeaea;
  color: #dc3545;
  border: 2px solid #f5c2c7;
}

/* When selected */
.attendance-option input[type="radio"]:checked + .attendance-label.present {
  background: #198754;
  color: white;
  border-color: #146c43;
}

.attendance-option input[type="radio"]:checked + .attendance-label.absent {
  background: #dc3545;
  color: white;
  border-color: #b02a37;
}

.attendance-label i {
  margin-right: 6px;
}
</style>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">

<!-- JS -->
<script>
function markAll(status) {
  const form = document.getElementById('attendanceForm');
  if (!form) return;
  const inputs = form.querySelectorAll(`input[type=radio][value="${status}"]`);
  inputs.forEach(input => {
    input.checked = true;
  });
}
</script>
{% endblock %}
